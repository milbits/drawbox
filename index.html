<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>drawbox</title>
		<style>
			* {
				box-sizing: border-box;
			}
			canvas {
				cursor: crosshair;
				width: 550px;
				height: 550px;
				padding: 3px;
			}

			#gallery {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				justify-content: center;
			}
			.image-container {
				box-shadow: inset -1px -1px #0a0a0a, inset 1px 1px #dfdfdf, inset -2px -2px grey, inset 2px 2px #fff;
				padding: 5px;
				max-width: 200px;
				text-align: center;
			}
			.image-container img {
				max-width: 100%;
				height: auto;
				display: block;
			}

			.flex {
				display: flex;
				margin: 1em;
				gap: 100px;
			}

			.leftSidebar {
				order: 1;
				box-shadow: inset -1px -1px #0a0a0a, inset 1px 1px #dfdfdf, inset -2px -2px grey, inset 2px 2px #fff;
				padding: 2px;
			}

			.rightSidebar {
				order: 2;
			}

			.galleryContainer {
				text-align: center;
				margin: 1rem;
				padding: 0;
				display: block;
			}
			@media (max-width: 860px) {
				canvas {
					display: block !important;
				}
				body {
					text-align: center;
				}
				canvas {
					width: 100%;
					height: 100%;
					margin: auto;
					padding: 0;
					display: block;
				}

				.flex {
					flex-wrap: wrap;
					flex-flow: column;
					gap: 0;
				}
				.leftSidebar {
					order: 2;
				}

				.rightSidebar {
					order: 1;
				}

				ul {
					text-align: left;
				}
			}
		</style>
		<link rel="stylesheet" href="./style.css?v=1.4" />
	</head>
	<body>
		<div class="container">
			<h1>drawbox!</h1>
			<p>if it's currently unavailable, <a href="https://straw.page/">use strawpage instead.</a> images will be manually added when i see them.</p>
			<p>no rules, draw whatever your little heart desires! nsfw will be hidden but is allowed</p>
			<canvas id="drawboxcanvas" width="550" height="550"></canvas>
			<br />
			<div onclick="change_color(this)" style="background: red" class="stroke-color"></div>
			<div onclick="change_color(this)" style="background: blue" class="stroke-color"></div>

			<button class="small" onclick="Restore()"> <img src="./undo.webp" style="image-rendering: pixelated" height="30" />Undo</button>
			<button class="small red" onclick="Clear()"><img src="./clear.webp" style="image-rendering: pixelated" height="30" />Clear</button>

			<input type="color" oninput="stroke_color = this.value" />
			<input type="range" min="1" max="100" oninput="stroke_width = this.value" />

			<button class="green" id="submit">Submit drawing</button>
			<p id="status"></p>

			<h1>Submitted Drawings</h1>
			<div id="gallery">Loading images...</div>
		</div>
		<script>
			/*
        
        FILL IN THESE VARIABLES BASED ON THE GUIDE AT https://drawbox.nekoweb.org
        
        
				      /`·.¸
				     /¸...¸`:·
				 ¸.·´  ¸   `·.¸.·´)
				: © ):´;      ¸  {
				 `·.¸ `·  ¸.·´\`·¸)
				     `\\´´\¸.·´
        
*/
			const GOOGLE_FORM_ID = "1FAIpQLSetYq8DTlSJeSZrUXVlwZ5Rs8SWIcLoqOSUSpHJJ77lpAZJGA";
			const ENTRY_ID = "entry.615467537";
			const GOOGLE_SHEET_ID = "14-utOcvASc-f3_BUI0sCBfAEzixdEhxr-kfjAGRcqUo";
			const DISPLAY_IMAGES = true;

			/*
        
        DONT EDIT BELOW THIS POINT IF YOU DONT KNOW WHAT YOU ARE DOING.
        
*/

			const CLIENT_ID = "b4fb95e0edc434c";
			const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/" + GOOGLE_SHEET_ID + "/export?format=csv";
			const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/" + GOOGLE_FORM_ID + "/formResponse";

			let canvas = document.getElementById("drawboxcanvas");
			let context = canvas.getContext("2d");
			context.fillStyle = "white";
			context.fillRect(0, 0, canvas.width, canvas.height);

			function setCanvasSize() {
				canvas.width = canvas.offsetWidth;
				canvas.height = canvas.offsetWidth;
				context.fillStyle = "white";
				context.fillRect(0, 0, canvas.width, canvas.height);
			}

			window.addEventListener("resize", setCanvasSize);

			setCanvasSize();

			let restore_array = [];
			let start_index = -1;
			let stroke_color = "black";
			let stroke_width = "2";
			let is_drawing = false;

			function change_color(element) {
				stroke_color = element.style.background;
			}

			function start(event) {
				is_drawing = true;
				context.beginPath();
				context.moveTo(getX(event), getY(event));
				event.preventDefault();
			}

			function draw(event) {
				if (!is_drawing) return;
				context.lineTo(getX(event), getY(event));
				context.strokeStyle = stroke_color;
				context.lineWidth = stroke_width;
				context.lineCap = "round";
				context.lineJoin = "round";
				context.stroke();
				event.preventDefault();
			}

			function stop(event) {
				if (!is_drawing) return;
				context.stroke();
				context.closePath();
				is_drawing = false;
				restore_array.push(context.getImageData(0, 0, canvas.width, canvas.height));
				start_index++;
				event.preventDefault();
			}

			function getX(event) {
				return event.pageX ? event.pageX - canvas.offsetLeft : event.targetTouches[0].pageX - canvas.offsetLeft;
			}

			function getY(event) {
				return event.pageY ? event.pageY - canvas.offsetTop : event.targetTouches[0].pageY - canvas.offsetTop;
			}

			canvas.addEventListener("touchstart", start, false);
			canvas.addEventListener("touchmove", draw, false);
			canvas.addEventListener("touchend", stop, false);
			canvas.addEventListener("mousedown", start, false);
			canvas.addEventListener("mousemove", draw, false);
			canvas.addEventListener("mouseup", stop, false);
			canvas.addEventListener("mouseout", stop, false);

			function Restore() {
				if (start_index <= 0) {
					Clear();
				} else {
					start_index--;
					restore_array.pop();
					context.putImageData(restore_array[start_index], 0, 0);
				}
			}

			function Clear() {
				context.fillStyle = "white";
				context.clearRect(0, 0, canvas.width, canvas.height);
				context.fillRect(0, 0, canvas.width, canvas.height);
				restore_array = [];
				start_index = -1;
			}

			context.drawImage = function () {
				console.warn("noo >:(");
			};

			document.getElementById("submit").addEventListener("click", async function () {
				const submitButton = document.getElementById("submit");
				const statusText = document.getElementById("status");

				submitButton.disabled = true;
				statusText.textContent = "Uploading...";

				const imageData = canvas.toDataURL("image/png");
				const blob = await (await fetch(imageData)).blob();
				const formData = new FormData();
				formData.append("image", blob, "drawing.png");

				try {
					const response = await fetch("https://api.imgur.com/3/image", {
						method: "POST",
						headers: { Authorization: `Client-ID ${CLIENT_ID}` },
						body: formData,
					});

					const data = await response.json();
					if (!data.success) throw new Error("Imgur upload failed");

					const imageUrl = data.data.link;
					console.log("Uploaded image URL:", imageUrl);

					const googleFormData = new FormData();
					googleFormData.append(ENTRY_ID, imageUrl);

					await fetch(GOOGLE_FORM_URL, {
						method: "POST",
						body: googleFormData,
						mode: "no-cors",
					});

					statusText.textContent = "Upload successful!";
					alert("your masterpiece has been uploaded");
					location.reload();
				} catch (error) {
					console.error(error);
					statusText.textContent = "Error uploading image.";
					alert("error uploading :c");
				} finally {
					submitButton.disabled = false;
				}
			});

			async function fetchImages() {
				if (!DISPLAY_IMAGES) {
					console.log("Image display is disabled.");
					return;
				}

				try {
					const response = await fetch(GOOGLE_SHEET_URL);
					const csvText = await response.text();
					const rows = csvText.split("\n").slice(1);

					const gallery = document.getElementById("gallery");
					gallery.innerHTML = "";
					rows.reverse().forEach((row) => {
						const columns = row.split(",");
						if (columns.length < 2) return;

						const timestamp = columns[0].trim();
						const imgUrl = columns[1].trim().replace(/"/g, "");

						if (imgUrl.startsWith("http")) {
							const div = document.createElement("div");
							div.classList.add("image-container");

							div.innerHTML = `
                    <img src="${imgUrl}" alt="drawing">
                    <p>${timestamp}</p>
                `;
							gallery.appendChild(div);
						}
					});
				} catch (error) {
					console.error("Error fetching images:", error);
					document.getElementById("gallery").textContent = "currently unavailable! youre either in north korea or i forgot to pay 5€ :c";
				}
			}

			fetchImages();
		</script>
	</body>
</html>
